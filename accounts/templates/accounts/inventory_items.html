{% extends 'accounts/base.html' %}
{% load thumbnail %}

{% block title %}{{ inventory.name }} — Items{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="d-flex align-items-center justify-content-between mb-3">
        <div>
            <h2 style="color:#667eea;">{{ inventory.emoji }} {{ inventory.name }}</h2>
            <p class="text-muted">Manage items inside this inventory.</p>
        </div>
        <div class="d-flex gap-2">
            <div class="input-group">
                <input id="searchInput" class="form-control" placeholder="Search items..." />
            </div>
            <select id="categoryFilter" class="form-select">
                <option value="all">All categories</option>
                {% for cat in categories %}
                    <option value="{{ cat.id }}">{{ cat.name }}</option>
                {% endfor %}
            </select>
            <button class="btn btn-outline-info btn-sm" data-bs-toggle="modal" data-bs-target="#createCategoryModal" title="Create new category">➕ Category</button>
            <select id="sortSelect" class="form-select">
                <option value="">Sort</option>
                <option value="name_asc">Name A–Z</option>
                <option value="name_desc">Name Z–A</option>
                <option value="qty_asc">Quantity low→high</option>
                <option value="qty_desc">Quantity high→low</option>
                <option value="exp_asc">Exp. soon→late</option>
                <option value="exp_desc">Exp. late→soon</option>
            </select>
            <button id="createItemBtn" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#itemModal">➕ Add Item</button>
        </div>
    </div>

    <div class="mb-2 d-flex align-items-center gap-2">
        <button id="toggleSelectBtn" class="btn btn-outline-secondary">Select Multiple</button>
        <div id="bulkActions" class="d-none">
            <button id="bulkDelete" class="btn btn-danger">Delete Selected</button>
            <button id="bulkIncrease" class="btn btn-secondary">Increase qty</button>
            <button id="bulkDecrease" class="btn btn-secondary">Decrease qty</button>
        </div>
    </div>

    <div id="itemsGrid" class="inventory-grid">
        {% for item in items %}
            <div class="inventory-card" data-item-id="{{ item.id }}">
                <input type="checkbox" class="select-checkbox d-none" />
                <button class="btn btn-sm btn-link edit-item-btn" data-item-id="{{ item.id }}" style="position:absolute; right:8px; top:8px;">✏️</button>
                <div class="inventory-emoji">
                    {% if item.image %}
                        {% thumbnail item.image "300x" quality=85 as im %}
                            <img src="{{ im.url }}" alt="{{ item.name }}" style="max-width:120px; max-height:120px; border-radius:8px;" />
                        {% endthumbnail %}
                    {% else %}
                        {{ item.inventory.emoji }}
                    {% endif %}
                </div>
                <div class="inventory-name">{{ item.name }}</div>
                <div class="text-muted small">{% if item.category %}{{ item.category.name }}{% endif %}</div>
                <div class="inventory-footer mt-3">
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-outline-secondary qty-decrease" data-item-id="{{ item.id }}">-</button>
                        <div class="px-2 qty-number" data-item-id="{{ item.id }}">{{ item.quantity }}</div>
                        <button class="btn btn-sm btn-outline-secondary qty-increase" data-item-id="{{ item.id }}">+</button>
                    </div>
                    <div class="mt-2">
                        {% if item.is_low_stock %}
                            <span class="badge bg-danger">Low stock</span>
                        {% endif %}
                        {% if item.is_expiring_soon %}
                            <span class="badge bg-warning text-dark">Expiring soon</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    <div class="mt-3">
        {% if items.has_other_pages %}
            <nav>
                <ul class="pagination">
                    {% if items.has_previous %}
                        <li class="page-item"><a class="page-link" href="?page={{ items.previous_page_number }}">Previous</a></li>
                    {% endif %}
                    <li class="page-item active"><span class="page-link">{{ items.number }}</span></li>
                    {% if items.has_next %}
                        <li class="page-item"><a class="page-link" href="?page={{ items.next_page_number }}">Next</a></li>
                    {% endif %}
                </ul>
            </nav>
        {% endif %}
    </div>
</div>

<!-- Create Category Modal -->
<div class="modal fade" id="createCategoryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header" style="border-bottom: 2px solid #667eea;">
                <h5 class="modal-title" style="color:#667eea; font-weight:bold;">Create New Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="createCategoryForm">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Category name</label>
                        <input id="categoryName" name="name" class="form-control" placeholder="e.g., Frozen Foods" required />
                    </div>
                    <div id="categoryFormAlert" class="alert d-none" role="alert"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-info" id="saveCategoryBtn">Create</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Item Modal (used for create & edit) -->
<div class="modal fade" id="itemModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header" style="border-bottom: 2px solid #667eea;">
                <h5 id="itemModalTitle" class="modal-title" style="color:#667eea; font-weight:bold;">Add Item</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="itemForm" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    <input type="hidden" id="itemId" name="item_id" />
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Item name</label>
                                <input id="itemName" name="name" class="form-control" required />
                            </div>
                            <div class="mb-3 d-flex gap-2">
                                <div style="flex:1">
                                    <label class="form-label">Quantity</label>
                                    <input id="itemQuantity" name="quantity" type="number" class="form-control" min="0" value="0" required />
                                </div>
                                <div style="flex:1">
                                    <label class="form-label">Category</label>
                                    <select id="itemCategory" name="category" class="form-select">
                                        <option value="">(none)</option>
                                        {% for cat in categories %}
                                            <option value="{{ cat.id }}">{{ cat.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Brand</label>
                                <input id="itemBrand" name="brand" class="form-control" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Description</label>
                                <textarea id="itemDescription" name="description" class="form-control" rows="4"></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Expiration date</label>
                                <input id="itemExpiration" name="expiration_date" type="date" class="form-control" />
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Image</label>
                                <input id="itemImage" name="image" type="file" accept="image/*" class="form-control" />
                                <div id="imagePreview" class="mt-2"></div>
                                <div class="form-check mt-2 d-none" id="removeImageWrap">
                                    <input class="form-check-input" type="checkbox" id="removeImage" name="remove_image" />
                                    <label class="form-check-label" for="removeImage">Remove existing image</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="itemFormAlert" class="alert d-none" role="alert"></div>

                    <hr />
                    <div>
                        <button type="button" class="btn btn-link" id="toggleLogs">Show activity log</button>
                        <div id="activityLog" class="mt-2 d-none" style="max-height:200px; overflow:auto;"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger d-none" id="deleteItemBtn">Delete Item</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" id="saveItemBtn" class="btn btn-success">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
const inventoryId = "{{ inventory.id }}";

// Helper: fetch wrapper with JSON
async function fetchJSON(url, opts={}){
    const res = await fetch(url, opts);
    return res.json();
}

// Image preview
const itemImage = document.getElementById('itemImage');
const imagePreview = document.getElementById('imagePreview');
itemImage?.addEventListener('change', (e)=>{
    const file = e.target.files[0];
    if(!file) { imagePreview.innerHTML = ''; return; }
    const url = URL.createObjectURL(file);
    imagePreview.innerHTML = `<img src="${url}" style="max-width:140px; max-height:140px; border-radius:8px;"/> <div><button id="removePreview" class="btn btn-sm btn-link">Remove</button></div>`;
    document.getElementById('removeImageWrap').classList.add('d-none');
    document.getElementById('removePreview')?.addEventListener('click', ()=>{ itemImage.value=''; imagePreview.innerHTML=''; });
});

// Open create modal
const createItemBtn = document.getElementById('createItemBtn');
createItemBtn?.addEventListener('click', ()=>{
    document.getElementById('itemModalTitle').textContent = 'Add Item';
    document.getElementById('itemForm').reset();
    document.getElementById('itemId').value = '';
    document.getElementById('removeImageWrap').classList.add('d-none');
    document.getElementById('deleteItemBtn').classList.add('d-none');
    document.getElementById('itemFormAlert').classList.add('d-none');
    imagePreview.innerHTML = '';
});

// Edit buttons
document.querySelectorAll('.edit-item-btn').forEach(btn=>{
    btn.addEventListener('click', async (e)=>{
        const id = btn.dataset.itemId;
        // fetch detail
        const res = await fetchJSON(`/accounts/inventories/${inventoryId}/items/${id}/detail/`);
        if(!res.success){ alert('Could not load item'); return; }
        const item = res.item;
        document.getElementById('itemModalTitle').textContent = 'Edit Item';
        document.getElementById('itemId').value = item.id;
        document.getElementById('itemName').value = item.name;
        document.getElementById('itemQuantity').value = item.quantity;
        document.getElementById('itemBrand').value = item.brand;
        document.getElementById('itemDescription').value = item.description;
        document.getElementById('itemExpiration').value = item.expiration_date || '';
        if(item.image_url){
            imagePreview.innerHTML = `<img src="${item.thumbnail_url || item.image_url}" style="max-width:140px; max-height:140px; border-radius:8px;"/>`;
            document.getElementById('removeImageWrap').classList.remove('d-none');
        } else {
            imagePreview.innerHTML = '';
            document.getElementById('removeImageWrap').classList.add('d-none');
        }
        if(item.category){
            document.getElementById('itemCategory').value = item.category_id || '';
        }
        document.getElementById('deleteItemBtn').classList.remove('d-none');
        // show modal
        const modalEl = document.getElementById('itemModal');
        const modal = new bootstrap.Modal(modalEl);
        modal.show();

        // populate logs
        const logs = res.logs || [];
        const logContainer = document.getElementById('activityLog');
        logContainer.innerHTML = logs.map(l=>`<div class="small"><strong>${l.action}</strong> — ${l.note || ''} <span class="text-muted">${l.timestamp}</span></div>`).join('');
        
        // Show activity log by default on edit
        logContainer.classList.remove('d-none');
        document.getElementById('toggleLogs').textContent = 'Hide activity log';
    });
});

// Submit item form (create or update) via FormData
document.getElementById('itemForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const id = document.getElementById('itemId').value;
    const url = id ? `/accounts/inventories/${inventoryId}/items/${id}/update/` : `/accounts/inventories/${inventoryId}/items/create/`;
    const form = document.getElementById('itemForm');
    const fd = new FormData(form);

    const res = await fetch(url, {
        method: 'POST',
        headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value },
        body: fd
    });
    const data = await res.json();
    if(data.success){
        location.reload();
    } else {
        const alert = document.getElementById('itemFormAlert');
        alert.classList.remove('d-none');
        alert.classList.add('alert-danger');
        alert.textContent = JSON.stringify(data.errors || data.error || 'Unknown error');
    }
});

// Delete item from modal
document.getElementById('deleteItemBtn').addEventListener('click', async ()=>{
    if(!confirm('Delete this item?')) return;
    const id = document.getElementById('itemId').value;
    const res = await fetchJSON(`/accounts/inventories/${inventoryId}/items/${id}/delete/`, {method:'POST', headers:{'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value}});
    if(res.success) location.reload(); else alert('Failed to delete');
});

// Quantity buttons
document.querySelectorAll('.qty-increase').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
        const id = btn.dataset.itemId;
        const res = await fetchJSON(`/accounts/inventories/${inventoryId}/items/${id}/quantity/`, {method:'POST', headers:{'Content-Type':'application/json','X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value}, body: JSON.stringify({action:'increase', amount:1})});
        if(res.success){ document.querySelector(`.qty-number[data-item-id='${id}']`).textContent = res.quantity; }
    });
});

document.querySelectorAll('.qty-decrease').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
        const id = btn.dataset.itemId;
        const res = await fetchJSON(`/accounts/inventories/${inventoryId}/items/${id}/quantity/`, {method:'POST', headers:{'Content-Type':'application/json','X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value}, body: JSON.stringify({action:'decrease', amount:1})});
        if(res.success){ document.querySelector(`.qty-number[data-item-id='${id}']`).textContent = res.quantity; }
    });
});

// Simple live search
const searchInput = document.getElementById('searchInput');
searchInput?.addEventListener('input', debounce(()=>{
    const q = searchInput.value.trim();
    const params = new URLSearchParams(window.location.search);
    params.set('q', q);
    window.location.search = params.toString();
}, 300));

// Filter and sort
document.getElementById('categoryFilter')?.addEventListener('change', ()=>{ applyFilters(); });
document.getElementById('sortSelect')?.addEventListener('change', ()=>{ applyFilters(); });
function applyFilters(){
    const params = new URLSearchParams(window.location.search);
    params.set('category', document.getElementById('categoryFilter').value);
    params.set('sort', document.getElementById('sortSelect').value);
    window.location.search = params.toString();
}

// Debounce helper
function debounce(fn, wait){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); }; }

// Bulk select toggle
let bulkMode = false;
document.getElementById('toggleSelectBtn').addEventListener('click', ()=>{
    bulkMode = !bulkMode;
    document.querySelectorAll('.select-checkbox').forEach(cb=> cb.classList.toggle('d-none', !bulkMode));
    document.getElementById('bulkActions').classList.toggle('d-none', !bulkMode);
    document.getElementById('toggleSelectBtn').textContent = bulkMode ? 'Exit Select' : 'Select Multiple';
});

function getSelectedIds(){ return Array.from(document.querySelectorAll('.select-checkbox:checked')).map(cb=> cb.closest('.inventory-card').dataset.itemId); }

document.getElementById('bulkDelete').addEventListener('click', async ()=>{
    const ids = getSelectedIds(); if(!ids.length) return alert('No items selected');
    if(!confirm('Delete selected items?')) return;
    const res = await fetchJSON(`/accounts/inventories/${inventoryId}/bulk/`, {method:'POST', headers:{'Content-Type':'application/json','X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value}, body: JSON.stringify({action:'delete', item_ids: ids})});
    if(res.success) location.reload(); else alert('Bulk delete failed');
});

document.getElementById('bulkIncrease').addEventListener('click', async ()=>{ const ids = getSelectedIds(); if(!ids.length) return alert('No items selected'); const res = await fetchJSON(`/accounts/inventories/${inventoryId}/bulk/`, {method:'POST', headers:{'Content-Type':'application/json','X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value}, body: JSON.stringify({action:'increase', item_ids: ids, amount:1})}); if(res.success) location.reload(); else alert('Bulk increase failed'); });

document.getElementById('bulkDecrease').addEventListener('click', async ()=>{ const ids = getSelectedIds(); if(!ids.length) return alert('No items selected'); const res = await fetchJSON(`/accounts/inventories/${inventoryId}/bulk/`, {method:'POST', headers:{'Content-Type':'application/json','X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value}, body: JSON.stringify({action:'decrease', item_ids: ids, amount:1})}); if(res.success) location.reload(); else alert('Bulk decrease failed'); });

// Toggle logs
document.getElementById('toggleLogs').addEventListener('click', ()=>{
    const el = document.getElementById('activityLog'); el.classList.toggle('d-none');
});

// Inline category creation
const createCategoryForm = document.getElementById('createCategoryForm');
const categoryFormAlert = document.getElementById('categoryFormAlert');
const saveCategoryBtn = document.getElementById('saveCategoryBtn');

createCategoryForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    categoryFormAlert.classList.add('d-none');
    saveCategoryBtn.disabled = true;
    saveCategoryBtn.textContent = 'Creating...';
    const name = document.getElementById('categoryName').value.trim();
    try {
        const res = await fetch('/accounts/categories/create/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
            body: JSON.stringify({ name })
        });
        const data = await res.json();
        if (data.success) {
            // Add new category to filter and item modal dropdowns
            const option = document.createElement('option');
            option.value = data.category.id;
            option.textContent = data.category.name;
            document.getElementById('categoryFilter').appendChild(option);
            document.getElementById('itemCategory').appendChild(option.cloneNode(true));
            categoryFormAlert.classList.remove('d-none', 'alert-danger');
            categoryFormAlert.classList.add('alert-success');
            categoryFormAlert.textContent = 'Category created!';
            createCategoryForm.reset();
            setTimeout(() => {
                const modal = bootstrap.Modal.getInstance(document.getElementById('createCategoryModal'));
                modal.hide();
                categoryFormAlert.classList.add('d-none');
                saveCategoryBtn.disabled = false;
                saveCategoryBtn.textContent = 'Create';
            }, 1000);
        } else {
            categoryFormAlert.classList.remove('d-none', 'alert-success');
            categoryFormAlert.classList.add('alert-danger');
            categoryFormAlert.textContent = data.error || 'Error creating category.';
            saveCategoryBtn.disabled = false;
            saveCategoryBtn.textContent = 'Create';
        }
    } catch (err) {
        categoryFormAlert.classList.remove('d-none', 'alert-success');
        categoryFormAlert.classList.add('alert-danger');
        categoryFormAlert.textContent = err.message || 'Error creating category.';
        saveCategoryBtn.disabled = false;
        saveCategoryBtn.textContent = 'Create';
    }
});
</script>
{% endblock %}