{% extends 'accounts/base.html' %}

{% block title %}Dashboard - Inventory Manager{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12 col-md-6 mb-3 mb-md-0">
            <h1 style="color: #667eea; font-weight: bold; font-size: clamp(20px, 5vw, 32px); margin: 0;">
                Welcome, {{ user.username }}! ğŸ‘‹
            </h1>
        </div>
        <div class="col-12 col-md-6 d-flex gap-2 flex-wrap justify-content-md-end">
            <button class="btn btn-success" style="width: 100%; max-width: 180px;" data-bs-toggle="modal" data-bs-target="#createInventoryModal">
                â• Create Inventory
            </button>
            <a href="{% url 'logout' %}" class="btn btn-danger" style="width: 100%; max-width: 150px;">Logout</a>
        </div>
    </div>

    <!-- Inventories Section -->
    <div class="mb-4">
        <h2 style="color: #667eea; font-size: clamp(18px, 4vw, 24px); font-weight: bold; margin-bottom: 20px;">Your Inventories</h2>
        
        {% if inventories %}
            <!-- Inventory Grid -->
            <div class="inventory-grid">
                {% for inventory in inventories %}
                    <div class="inventory-card position-relative">
                        <button class="btn btn-sm btn-link edit-inventory-btn" data-inventory-id="{{ inventory.id }}" style="position:absolute; right:8px; top:8px;">âœï¸</button>
                        <div class="inventory-emoji">{{ inventory.emoji }}</div>
                        <div class="inventory-name">{{ inventory.name }}</div>
                        <div class="inventory-footer">
                            <a href="{% url 'inventory_items' inventory.id %}" class="btn btn-sm btn-primary">Open</a>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <!-- Empty State -->
            <div class="empty-state">
                <div style="font-size: 64px; margin-bottom: 20px;">ğŸ“­</div>
                <h3 style="color: #667eea; margin-bottom: 10px;">No Inventories Yet</h3>
                <p style="color: #666; margin-bottom: 20px; font-size: 16px;">Create your first inventory to get started!</p>
                <button class="btn btn-success btn-lg" data-bs-toggle="modal" data-bs-target="#createInventoryModal">
                    â• Create Your First Inventory
                </button>
            </div>
        {% endif %}
    </div>
</div>

<!-- Create Inventory Modal -->
<div class="modal fade" id="createInventoryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header" style="border-bottom: 2px solid #667eea;">
                <h5 class="modal-title" style="color: #667eea; font-weight: bold;">Create New Inventory</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="createInventoryForm">
                {% csrf_token %}
                <div class="modal-body" style="max-height: 500px; overflow-y: auto;">
                    <div class="mb-3">
                        <label for="inventoryName" class="form-label" style="color: #667eea; font-weight: bold;">Inventory Name</label>
                        <input type="text" class="form-control" id="inventoryName" name="name" placeholder="e.g., Office Supplies" required maxlength="255" style="border: 1px solid #ddd; border-radius: 6px;">
                    </div>
                    <div class="mb-3">
                        <label class="form-label" style="color: #667eea; font-weight: bold;">Select Emoji</label>
                        <div class="emoji-selector">
                            <div class="form-check"><input class="form-check-input emoji-radio" type="radio" name="emoji" value="ğŸ“¦" id="emoji_box" checked><label class="form-check-label emoji-label" for="emoji_box"><span class="emoji-icon">ğŸ“¦</span> Box</label></div>
                            <div class="form-check"><input class="form-check-input emoji-radio" type="radio" name="emoji" value="ğŸ " id="emoji_house"><label class="form-check-label emoji-label" for="emoji_house"><span class="emoji-icon">ğŸ </span> House</label></div>
                            <div class="form-check"><input class="form-check-input emoji-radio" type="radio" name="emoji" value="ğŸ" id="emoji_gift"><label class="form-check-label emoji-label" for="emoji_gift"><span class="emoji-icon">ğŸ</span> Gift</label></div>
                            <div class="form-check"><input class="form-check-input emoji-radio" type="radio" name="emoji" value="ğŸ“š" id="emoji_books"><label class="form-check-label emoji-label" for="emoji_books"><span class="emoji-icon">ğŸ“š</span> Books</label></div>
                            <div class="form-check"><input class="form-check-input emoji-radio" type="radio" name="emoji" value="ğŸ•" id="emoji_pizza"><label class="form-check-label emoji-label" for="emoji_pizza"><span class="emoji-icon">ğŸ•</span> Pizza</label></div>
                            <div class="form-check"><input class="form-check-input emoji-radio" type="radio" name="emoji" value="ğŸ›’" id="emoji_cart"><label class="form-check-label emoji-label" for="emoji_cart"><span class="emoji-icon">ğŸ›’</span> Cart</label></div>
                            <div class="form-check"><input class="form-check-input emoji-radio" type="radio" name="emoji" value="ğŸ’¼" id="emoji_briefcase"><label class="form-check-label emoji-label" for="emoji_briefcase"><span class="emoji-icon">ğŸ’¼</span> Briefcase</label></div>
                            <div class="form-check"><input class="form-check-input emoji-radio" type="radio" name="emoji" value="ğŸ®" id="emoji_gaming"><label class="form-check-label emoji-label" for="emoji_gaming"><span class="emoji-icon">ğŸ®</span> Gaming</label></div>
                            <div class="form-check"><input class="form-check-input emoji-radio" type="radio" name="emoji" value="ğŸ“±" id="emoji_phone"><label class="form-check-label emoji-label" for="emoji_phone"><span class="emoji-icon">ğŸ“±</span> Phone</label></div>
                            <div class="form-check"><input class="form-check-input emoji-radio" type="radio" name="emoji" value="ğŸ‘•" id="emoji_shirt"><label class="form-check-label emoji-label" for="emoji_shirt"><span class="emoji-icon">ğŸ‘•</span> Shirt</label></div>
                            <div class="form-check"><input class="form-check-input emoji-radio" type="radio" name="emoji" value="ğŸ¨" id="emoji_art"><label class="form-check-label emoji-label" for="emoji_art"><span class="emoji-icon">ğŸ¨</span> Art</label></div>
                            <div class="form-check"><input class="form-check-input emoji-radio" type="radio" name="emoji" value="ğŸ”§" id="emoji_tools"><label class="form-check-label emoji-label" for="emoji_tools"><span class="emoji-icon">ğŸ”§</span> Tools</label></div>
                            <div class="form-check"><input class="form-check-input emoji-radio" type="radio" name="emoji" value="ğŸŒ±" id="emoji_plant"><label class="form-check-label emoji-label" for="emoji_plant"><span class="emoji-icon">ğŸŒ±</span> Plant</label></div>
                            <div class="form-check"><input class="form-check-input emoji-radio" type="radio" name="emoji" value="âš½" id="emoji_sports"><label class="form-check-label emoji-label" for="emoji_sports"><span class="emoji-icon">âš½</span> Sports</label></div>
                            <div class="form-check"><input class="form-check-input emoji-radio" type="radio" name="emoji" value="ğŸµ" id="emoji_music"><label class="form-check-label emoji-label" for="emoji_music"><span class="emoji-icon">ğŸµ</span> Music</label></div>
                            <div class="form-check"><input class="form-check-input emoji-radio" type="radio" name="emoji" value="ğŸ“¸" id="emoji_photo"><label class="form-check-label emoji-label" for="emoji_photo"><span class="emoji-icon">ğŸ“¸</span> Photo</label></div>
                            <div class="form-check"><input class="form-check-input emoji-radio" type="radio" name="emoji" value="ğŸ”" id="emoji_food"><label class="form-check-label emoji-label" for="emoji_food"><span class="emoji-icon">ğŸ”</span> Food</label></div>
                            <div class="form-check"><input class="form-check-input emoji-radio" type="radio" name="emoji" value="âœˆï¸" id="emoji_travel"><label class="form-check-label emoji-label" for="emoji_travel"><span class="emoji-icon">âœˆï¸</span> Travel</label></div>
                            <div class="form-check"><input class="form-check-input emoji-radio" type="radio" name="emoji" value="ğŸ’»" id="emoji_tech"><label class="form-check-label emoji-label" for="emoji_tech"><span class="emoji-icon">ğŸ’»</span> Tech</label></div>
                            <div class="form-check"><input class="form-check-input emoji-radio" type="radio" name="emoji" value="ğŸ‹ï¸" id="emoji_fitness"><label class="form-check-label emoji-label" for="emoji_fitness"><span class="emoji-icon">ğŸ‹ï¸</span> Fitness</label></div>
                        </div>
                    </div>
                    <div id="formAlert" class="alert d-none" role="alert"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success" id="submitBtn">Create Inventory</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Inventory Modal -->
<div class="modal fade" id="editInventoryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header" style="border-bottom: 2px solid #667eea;">
                <h5 class="modal-title" style="color: #667eea; font-weight: bold;">Edit Inventory</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editInventoryForm">
                {% csrf_token %}
                <input type="hidden" id="editInventoryId" name="inventory_id" />
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editInventoryName" class="form-label" style="color: #667eea; font-weight: bold;">Inventory Name</label>
                        <input type="text" class="form-control" id="editInventoryName" name="name" required maxlength="255" style="border: 1px solid #ddd; border-radius: 6px;">
                    </div>
                    <div class="mb-3">
                        <label class="form-label" style="color: #667eea; font-weight: bold;">Select Emoji</label>
                        <div class="emoji-selector">
                            <div class="form-check"><input class="form-check-input edit-emoji-radio" type="radio" name="emoji" value="ğŸ“¦" id="edit_emoji_box"><label class="form-check-label emoji-label" for="edit_emoji_box"><span class="emoji-icon">ğŸ“¦</span> Box</label></div>
                            <div class="form-check"><input class="form-check-input edit-emoji-radio" type="radio" name="emoji" value="ğŸ " id="edit_emoji_house"><label class="form-check-label emoji-label" for="edit_emoji_house"><span class="emoji-icon">ğŸ </span> House</label></div>
                            <div class="form-check"><input class="form-check-input edit-emoji-radio" type="radio" name="emoji" value="ğŸ" id="edit_emoji_gift"><label class="form-check-label emoji-label" for="edit_emoji_gift"><span class="emoji-icon">ğŸ</span> Gift</label></div>
                            <div class="form-check"><input class="form-check-input edit-emoji-radio" type="radio" name="emoji" value="ğŸ“š" id="edit_emoji_books"><label class="form-check-label emoji-label" for="edit_emoji_books"><span class="emoji-icon">ğŸ“š</span> Books</label></div>
                            <div class="form-check"><input class="form-check-input edit-emoji-radio" type="radio" name="emoji" value="ğŸ•" id="edit_emoji_pizza"><label class="form-check-label emoji-label" for="edit_emoji_pizza"><span class="emoji-icon">ğŸ•</span> Pizza</label></div>
                            <div class="form-check"><input class="form-check-input edit-emoji-radio" type="radio" name="emoji" value="ğŸ›’" id="edit_emoji_cart"><label class="form-check-label emoji-label" for="edit_emoji_cart"><span class="emoji-icon">ğŸ›’</span> Cart</label></div>
                            <div class="form-check"><input class="form-check-input edit-emoji-radio" type="radio" name="emoji" value="ğŸ’¼" id="edit_emoji_briefcase"><label class="form-check-label emoji-label" for="edit_emoji_briefcase"><span class="emoji-icon">ğŸ’¼</span> Briefcase</label></div>
                            <div class="form-check"><input class="form-check-input edit-emoji-radio" type="radio" name="emoji" value="ğŸ®" id="edit_emoji_gaming"><label class="form-check-label emoji-label" for="edit_emoji_gaming"><span class="emoji-icon">ğŸ®</span> Gaming</label></div>
                            <div class="form-check"><input class="form-check-input edit-emoji-radio" type="radio" name="emoji" value="ğŸ“±" id="edit_emoji_phone"><label class="form-check-label emoji-label" for="edit_emoji_phone"><span class="emoji-icon">ğŸ“±</span> Phone</label></div>
                            <div class="form-check"><input class="form-check-input edit-emoji-radio" type="radio" name="emoji" value="ğŸ‘•" id="edit_emoji_shirt"><label class="form-check-label emoji-label" for="edit_emoji_shirt"><span class="emoji-icon">ğŸ‘•</span> Shirt</label></div>
                            <div class="form-check"><input class="form-check-input edit-emoji-radio" type="radio" name="emoji" value="ğŸ¨" id="edit_emoji_art"><label class="form-check-label emoji-label" for="edit_emoji_art"><span class="emoji-icon">ğŸ¨</span> Art</label></div>
                            <div class="form-check"><input class="form-check-input edit-emoji-radio" type="radio" name="emoji" value="ğŸ”§" id="edit_emoji_tools"><label class="form-check-label emoji-label" for="edit_emoji_tools"><span class="emoji-icon">ğŸ”§</span> Tools</label></div>
                            <div class="form-check"><input class="form-check-input edit-emoji-radio" type="radio" name="emoji" value="ğŸŒ±" id="edit_emoji_plant"><label class="form-check-label emoji-label" for="edit_emoji_plant"><span class="emoji-icon">ğŸŒ±</span> Plant</label></div>
                            <div class="form-check"><input class="form-check-input edit-emoji-radio" type="radio" name="emoji" value="âš½" id="edit_emoji_sports"><label class="form-check-label emoji-label" for="edit_emoji_sports"><span class="emoji-icon">âš½</span> Sports</label></div>
                            <div class="form-check"><input class="form-check-input edit-emoji-radio" type="radio" name="emoji" value="ğŸµ" id="edit_emoji_music"><label class="form-check-label emoji-label" for="edit_emoji_music"><span class="emoji-icon">ğŸµ</span> Music</label></div>
                            <div class="form-check"><input class="form-check-input edit-emoji-radio" type="radio" name="emoji" value="ğŸ“¸" id="edit_emoji_photo"><label class="form-check-label emoji-label" for="edit_emoji_photo"><span class="emoji-icon">ğŸ“¸</span> Photo</label></div>
                            <div class="form-check"><input class="form-check-input edit-emoji-radio" type="radio" name="emoji" value="ğŸ”" id="edit_emoji_food"><label class="form-check-label emoji-label" for="edit_emoji_food"><span class="emoji-icon">ğŸ”</span> Food</label></div>
                            <div class="form-check"><input class="form-check-input edit-emoji-radio" type="radio" name="emoji" value="âœˆï¸" id="edit_emoji_travel"><label class="form-check-label emoji-label" for="edit_emoji_travel"><span class="emoji-icon">âœˆï¸</span> Travel</label></div>
                            <div class="form-check"><input class="form-check-input edit-emoji-radio" type="radio" name="emoji" value="ğŸ’»" id="edit_emoji_tech"><label class="form-check-label emoji-label" for="edit_emoji_tech"><span class="emoji-icon">ğŸ’»</span> Tech</label></div>
                            <div class="form-check"><input class="form-check-input edit-emoji-radio" type="radio" name="emoji" value="ğŸ‹ï¸" id="edit_emoji_fitness"><label class="form-check-label emoji-label" for="edit_emoji_fitness"><span class="emoji-icon">ğŸ‹ï¸</span> Fitness</label></div>
                        </div>
                    </div>
                    <div id="editInventoryFormAlert" class="alert d-none" role="alert"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" id="deleteInventoryBtn">Delete Inventory</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('createInventoryForm');
    const formAlert = document.getElementById('formAlert');
    const submitBtn = document.getElementById('submitBtn');

    // Create inventory form submission - delegated
    document.addEventListener('submit', async function(e) {
        if (e.target.id !== 'createInventoryForm') return;
        
        e.preventDefault();
        formAlert.classList.add('d-none');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Creating...';

        try {
            const name = document.getElementById('inventoryName').value.trim();
            const emoji = document.querySelector('input[name="emoji"]:checked').value;

            const response = await fetch('{% url "create_inventory" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                },
                body: JSON.stringify({ name, emoji })
            });

            const data = await response.json();

            if (data.success) {
                formAlert.classList.remove('d-none', 'alert-danger');
                formAlert.classList.add('alert-success');
                formAlert.innerHTML = `<strong>âœ“ Success!</strong> ${data.message}`;
                form.reset();
                setTimeout(() => { location.reload(); }, 1500);
            } else {
                formAlert.classList.remove('d-none', 'alert-success');
                formAlert.classList.add('alert-danger');
                formAlert.innerHTML = `<strong>âœ— Error:</strong> ${data.error}`;
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Create Inventory';
            }
        } catch (error) {
            formAlert.classList.remove('d-none', 'alert-success');
            formAlert.classList.add('alert-danger');
            formAlert.innerHTML = `<strong>âœ— Error:</strong> ${error.message}`;
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'Create Inventory';
        }
    });

    // Edit inventory button - delegated
    document.addEventListener('click', function(e) {
        if (e.target.closest('.edit-inventory-btn')) {
            const btn = e.target.closest('.edit-inventory-btn');
            const card = btn.closest('.inventory-card');
            const inventoryId = btn.getAttribute('data-inventory-id');
            const inventoryName = card.querySelector('.inventory-name').textContent.trim();
            const inventoryEmoji = card.querySelector('.inventory-emoji').textContent.trim();
            
            document.getElementById('editInventoryId').value = inventoryId;
            document.getElementById('editInventoryName').value = inventoryName;
            document.querySelectorAll('.edit-emoji-radio').forEach(radio => {
                radio.checked = radio.value === inventoryEmoji;
            });
            document.getElementById('editInventoryFormAlert').classList.add('d-none');
            const modal = new bootstrap.Modal(document.getElementById('editInventoryModal'));
            modal.show();
        }
    });

    // Delete inventory button - delegated
    document.addEventListener('click', async function(e) {
        if (e.target.id !== 'deleteInventoryBtn') return;
        
        if (!confirm('Are you sure you want to delete this inventory and all its items? This cannot be undone.')) return;
        const inventoryId = document.getElementById('editInventoryId').value;
        const editAlert = document.getElementById('editInventoryFormAlert');
        
        try {
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
            if (!csrfToken) {
                throw new Error('CSRF token not found');
            }
            
            const response = await fetch(`/accounts/inventories/${inventoryId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken.value,
                }
            });
            
            if (!response.ok) {
                throw new Error(`Server error: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.success) {
                editAlert.classList.remove('d-none', 'alert-danger');
                editAlert.classList.add('alert-success');
                editAlert.innerHTML = '<strong>âœ“ Success!</strong> Inventory deleted.';
                setTimeout(() => { location.reload(); }, 1000);
            } else {
                editAlert.classList.remove('d-none', 'alert-success');
                editAlert.classList.add('alert-danger');
                editAlert.innerHTML = `<strong>âœ— Error:</strong> ${data.error}`;
            }
        } catch (error) {
            editAlert.classList.remove('d-none', 'alert-success');
            editAlert.classList.add('alert-danger');
            editAlert.innerHTML = `<strong>âœ— Error:</strong> ${error.message}`;
            console.error('Delete error:', error);
        }
    });

    // Edit inventory form submission - delegated
    document.addEventListener('submit', async function(e) {
        if (e.target.id !== 'editInventoryForm') return;
        
        e.preventDefault();
        const inventoryId = document.getElementById('editInventoryId').value;
        const name = document.getElementById('editInventoryName').value.trim();
        const emoji = document.querySelector('.edit-emoji-radio:checked').value;
        const editAlert = document.getElementById('editInventoryFormAlert');
        
        try {
            const response = await fetch(`/accounts/inventories/${inventoryId}/update/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                },
                body: JSON.stringify({ name, emoji })
            });
            const data = await response.json();
            
            if (data.success) {
                editAlert.classList.remove('d-none', 'alert-danger');
                editAlert.classList.add('alert-success');
                editAlert.innerHTML = '<strong>âœ“ Success!</strong> Inventory updated.';
                setTimeout(() => { location.reload(); }, 1000);
            } else {
                editAlert.classList.remove('d-none', 'alert-success');
                editAlert.classList.add('alert-danger');
                editAlert.innerHTML = `<strong>âœ— Error:</strong> ${data.error}`;
            }
        } catch (error) {
            editAlert.classList.remove('d-none', 'alert-success');
            editAlert.classList.add('alert-danger');
            editAlert.innerHTML = `<strong>âœ— Error:</strong> ${error.message}`;
        }
    });
});
</script>
{% endblock %}
